// See https://aka.ms/new-console-template for more information
using System.Diagnostics;

namespace lyricism
{
    public class Program
    {

        static void Main(string artistName, string trackName, string extractor)
        {
            // , string albumName
            string albumName = null;

            if (string.IsNullOrWhiteSpace(artistName) && string.IsNullOrWhiteSpace(trackName))
            {
                Console.WriteLine("Missing required arguments.");
                System.CommandLine.DragonFruit.CommandLine.ExecuteAssembly(typeof(AutoGeneratedProgram).Assembly, new string[] { "--help" }, "");
                return;
            }

            if (Debugger.IsAttached)
            {
                artistName = "feminazgul";
                trackName = "mother";
                artistName = "frog lord";
                trackName = "ampibian";
            }

            var extractors = AppDomain.CurrentDomain.GetAssemblies().SelectMany(x => x.GetTypes())
                  .Where(x => typeof(LyricExtractor).IsAssignableFrom(x) && !x.IsInterface && !x.IsAbstract)
                  .Select(x => x.GetConstructors().First().Invoke(new object[] { artistName, trackName, albumName }))
                  .Cast<LyricExtractor>()
                  .Where(x => x != null && (1 == 2
                              || (!string.IsNullOrWhiteSpace(extractor) && x.SourceName.Contains(extractor, StringComparison.InvariantCultureIgnoreCase))
                              || (string.IsNullOrWhiteSpace(extractor) && x.Active)
                              ))
                  // .OrderByDescending(x => x.SourceName)
                  .ToList();

            LyricExtractor ex = null;
            // var ex = extractors.FirstOrDefault(e => !string.IsNullOrWhiteSpace(e.Lyrics));
            var i = 0;
            foreach (var extra in extractors)
            {
                i+=1;
                Console.Write("\rChecking sources: " + i.ToString());
                if (!string.IsNullOrWhiteSpace(extra.Lyrics))
                {
                    Console.WriteLine();
                    ex = extra;
                    break;
                }
            }
            Console.WriteLine();

            if (ex == null)
            {
                Console.WriteLine("Could not find lyrics.");
                return;
            }

            Console.WriteLine(ex.ArtistName + " - " + ex.TrackName);
            Console.WriteLine("    " + ex.SourceName);
            Console.WriteLine();
            Console.WriteLine("-----------");
            Console.WriteLine();
            Console.WriteLine(ex.Lyrics);
        }
    }
}
